stages:
  - test
  - deploy

# This pipeline is used for internal testing and verification of the lab environment
# by the maintainer. Local users can ignore this or use it as a reference.

variables:
  DEPLOY_DIR: /services

.deploy_template: &deploy_template
  stage: deploy
  when: manual
  before_script:
    - apt-get update && apt-get install -y gettext-base openssh-client
    - eval $(ssh-agent -s)
    - chmod 400 "${SSH_PRIVATE_KEY}"
    - ssh-add "${SSH_PRIVATE_KEY}"
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - cp "${SSH_KNOWN_HOSTS}" ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts
    - echo "StrictHostKeyChecking no" >> ~/.ssh/config
  script:
    - SERVICE="${DEPLOY_DIR}/${SERVICE_NAME}"
    - ENV_FILE="${SERVICE}/env.sample"
    - TEMP_ENV="${SERVICE_NAME}.env"
    
    # Validate environment file exists
    - |
      if [ ! -f "${ENV_FILE}" ]; then
        echo "ERROR: ${ENV_FILE} not found"
        exit 1
      fi
    
    # Generate environment file from template
    - envsubst < "${ENV_FILE}" > "${TEMP_ENV}"
    
    # Deploy to remote
    - scp -P "${SSH_PORT}" "${TEMP_ENV}" "${SSH_USER}@${CONTROLLER}:${SERVICE}/.env"
    - |
      ssh -p "${SSH_PORT}" "${SSH_USER}@${CONTROLLER}" \
        "cd ${DEPLOY_DIR} && \
         git pull && \
         cd ${SERVICE} && \
         docker compose pull && \
         docker compose up -d && \
         echo 'Deployment completed successfully'"
    
    # Cleanup
    - rm -f "${TEMP_ENV}"
  after_script:
    - rm -f "${TEMP_ENV}" || true

deploy_traefik:
  <<: *deploy_template
  variables:
    SERVICE_NAME: traefik
  rules:
    - changes:
        - services/traefik/**

# Service deployments
deploy_wud:
  <<: *deploy_template
  variables:
    SERVICE_NAME: wud
  rules:
    - changes: 
        - services/wud/**

deploy_portainer:
  <<: *deploy_template
  variables:
    SERVICE_NAME: portainer
  rules:
    - changes: 
        - services/portainer/**

deploy_mysql:
  <<: *deploy_template
  variables:
    SERVICE_NAME: mysql
  rules:
    - changes: 
        - services/mysql/**

deploy_pgsql:
  <<: *deploy_template
  variables:
    SERVICE_NAME: pgsql
  rules:
    - changes:
        - pgsql/**

deploy_n8n:
  <<: *deploy_template
  variables:
    SERVICE_NAME: n8n
  rules:
    - changes:
        - services/n8n/**

deploy_grafana:
  <<: *deploy_template
  variables:
    SERVICE_NAME: grafana
  rules:
    - changes:
        - services/grafana/**

deploy_prometheus:
  <<: *deploy_template
  variables:
    SERVICE_NAME: prometheus
  rules:
    - changes:
        - services/prometheus/**
        