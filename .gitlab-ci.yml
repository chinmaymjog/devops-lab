stages:
  - test
  - deploy

# Global Workflow Rules
workflow:
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      when: never
    - when: always

variables:
  DEPLOY_DIR: "/services"

# Hidden job for SSH & Tooling Setup
.setup_ssh:
  before_script:
    - echo "--- Preparing Environment ---"
    - apt-get update && apt-get install -y gettext-base openssh-client
    - eval $(ssh-agent -s)
    - chmod 400 "${SSH_PRIVATE_KEY}"
    - ssh-add "${SSH_PRIVATE_KEY}"
    - mkdir -p ~/.ssh && chmod 700 ~/.ssh
    - cp "${SSH_KNOWN_HOSTS}" ~/.ssh/known_hosts && chmod 644 ~/.ssh/known_hosts
    - echo "StrictHostKeyChecking no" >> ~/.ssh/config

# Hidden job for Deployment Logic
.deploy_template:
  extends: .setup_ssh
  stage: deploy
  script:
    - echo "--- Deploying Service:${SERVICE_NAME} ---"
    - SERVICE_ROOT="services/${SERVICE_NAME}"
    - REMOTE_PATH="${DEPLOY_DIR}/services/${SERVICE_NAME}"
    - ENV_FILE="${SERVICE_ROOT}/.env.template"
    - LOCAL_DOTENV="${SERVICE_ROOT}/.env"
    
    - |
      if [ ! -f "${ENV_FILE}" ]; then
        echo "ERROR: ${ENV_FILE} not found"
        exit 1
      fi
    
    - echo "Generating .env from template..."
    - envsubst < "${ENV_FILE}" > "${LOCAL_DOTENV}"
    
    - echo "Updating remote repository..."
    - |
      ssh -p "${SSH_PORT}" "${SSH_USER}@${CONTROLLER}" \
        "cd ${DEPLOY_DIR} && git fetch --all && git reset --hard origin/${CI_COMMIT_BRANCH} && git pull"
    
    - echo "Uploading configuration..."
    - scp -P "${SSH_PORT}" "${LOCAL_DOTENV}" "${SSH_USER}@${CONTROLLER}:${REMOTE_PATH}/.env"
    
    - echo "Executing remote deployment..."
    - |
      ssh -p "${SSH_PORT}" "${SSH_USER}@${CONTROLLER}" \
        "cd ${REMOTE_PATH} && \
         docker compose pull && \
         docker compose up -d && \
         echo 'Deployment of ${SERVICE_NAME} completed successfully'"
  after_script:
    - rm -f "services/${SERVICE_NAME}/.env" || true

# --- Service Deployments ---

deploy_traefik:
  extends: .deploy_template
  variables:
    SERVICE_NAME: "traefik"
  rules:
    - if: $CI_COMMIT_BRANCH == "develop"
      changes:
        - services/traefik/**

deploy_wud:
  extends: .deploy_template
  variables:
    SERVICE_NAME: "wud"
  rules:
    - if: $CI_COMMIT_BRANCH == "develop"
      changes:
        - services/wud/**

deploy_portainer:
  extends: .deploy_template
  variables:
    SERVICE_NAME: "portainer"
  rules:
    - if: $CI_COMMIT_BRANCH == "develop"
      changes:
        - services/portainer/**

deploy_mysql:
  extends: .deploy_template
  variables:
    SERVICE_NAME: "mysql"
  rules:
    - if: $CI_COMMIT_BRANCH == "develop"
      changes:
        - services/mysql/**

deploy_pgsql:
  extends: .deploy_template
  variables:
    SERVICE_NAME: "pgsql"
  rules:
    - if: $CI_COMMIT_BRANCH == "develop"
      changes:
        - services/pgsql/**

deploy_n8n:
  extends: .deploy_template
  variables:
    SERVICE_NAME: "n8n"
  rules:
    - if: $CI_COMMIT_BRANCH == "develop"
      changes:
        - services/n8n/**

deploy_grafana:
  extends: .deploy_template
  variables:
    SERVICE_NAME: "grafana"
  rules:
    - if: $CI_COMMIT_BRANCH == "develop"
      changes:
        - services/grafana/**

deploy_prometheus:
  extends: .deploy_template
  variables:
    SERVICE_NAME: "prometheus"
  rules:
    - if: $CI_COMMIT_BRANCH == "develop"
      changes:
        - services/prometheus/**