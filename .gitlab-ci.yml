stages:
  - deploy

variables:
  DEPLOY_DIR: /tools

.deploy_template: &deploy_template
  stage: deploy
  when: manual
  before_script:
    - apt-get update && apt-get install -y gettext-base openssh-client
    - eval $(ssh-agent -s)
    - chmod 400 "$SSH_PRIVATE_KEY"
    - ssh-add "$SSH_PRIVATE_KEY"
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - cp "$SSH_KNOWN_HOSTS" ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts
    - echo "StrictHostKeyChecking no" >> ~/.ssh/config
  script:
    - SERVICE=$SERVICE_NAME
    - ENV_FILE="${SERVICE}/env.sample"
    - TEMP_ENV="${SERVICE}.env"
    
    # Validate environment file exists
    - |
      if [ ! -f "$ENV_FILE" ]; then
        echo "ERROR: $ENV_FILE not found"
        exit 1
      fi
    
    # Generate environment file from template
    - envsubst < "$ENV_FILE" > "$TEMP_ENV"
    
    # Deploy to remote
    - scp -P "$SSH_PORT" "$TEMP_ENV" "$SSH_USER@$CONTROLLER:${DEPLOY_DIR}/${SERVICE}/.env"
    - |
      ssh -p "$SSH_PORT" "$SSH_USER@$CONTROLLER" \
        "cd ${DEPLOY_DIR} && \
         git pull && \
         cd ${DEPLOY_DIR}/${SERVICE} && \
         docker compose pull && \
         docker compose up -d && \
         echo 'Deployment completed successfully'"
    
    # Cleanup
    - rm -f "$TEMP_ENV"
  after_script:
    - rm -f "$TEMP_ENV" || true

deploy_traefik:
  <<: *deploy_template
  variables:
    SERVICE_NAME: traefik
  rules:
    - changes:
        - traefik/**

# Service deployments
deploy_wud:
  <<: *deploy_template
  variables:
    SERVICE_NAME: wud
  rules:
    - changes: 
        - wud/**

deploy_portainer:
  <<: *deploy_template
  variables:
    SERVICE_NAME: portainer
  rules:
    - changes: 
        - portainer/**

deploy_runner:
  <<: *deploy_template
  variables:
    SERVICE_NAME: gitlab-runner
  rules:
    - changes:
        - gitlab-runner/**/*
  script:
    - SERVICE=$SERVICE_NAME
    - ENV_FILE="${SERVICE}/config/config.sample"
    - TEMP_ENV="${SERVICE}.env"
    - REMOTE_PATH="${DEPLOY_DIR}/${SERVICE}/config/config.toml"
    
    # Validate environment file exists
    - |
      if [ ! -f "$ENV_FILE" ]; then
        echo "ERROR: $ENV_FILE not found"
        exit 1
      fi
    
    # Generate environment file from template
    - envsubst < "$ENV_FILE" > "$TEMP_ENV"
    
    # Deploy to remote
    - scp -P "$SSH_PORT" "$TEMP_ENV" "$SSH_USER@$CONTROLLER:$REMOTE_PATH"
    - |
      ssh -p "$SSH_PORT" "$SSH_USER@$CONTROLLER" \
        "cd ${DEPLOY_DIR} && \
         git pull && \
         cd ${DEPLOY_DIR}/${SERVICE} && \
         docker compose pull && \
         docker compose up -d && \
         echo 'Deployment completed successfully'"
    
    # Cleanup
    - rm -f "$TEMP_ENV"

deploy_mysql:
  <<: *deploy_template
  variables:
    SERVICE_NAME: mysql
  rules:
    - changes: 
        - mysql/**

# deploy_pgsql:
#   <<: *deploy_template
#   variables:
#     SERVICE_NAME: pgsql
#   rules:
#     - changes:
#         - pgsql/**

deploy_n8n:
  <<: *deploy_template
  variables:
    SERVICE_NAME: n8n
  rules:
    - changes:
        - n8n/**

# deploy_keycloak:
#   <<: *deploy_template
#   variables:
#     SERVICE_NAME: keycloak
#   rules:
#     - changes:
#         - keycloak/**

deploy_grafana:
  <<: *deploy_template
  variables:
    SERVICE_NAME: grafana
  rules:
    - changes:
        - grafana/**

deploy_prometheus:
  <<: *deploy_template
  variables:
    SERVICE_NAME: prometheus
  rules:
    - changes:
        - prometheus/**
        